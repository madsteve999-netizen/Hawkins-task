<!DOCTYPE html>
<html lang="ru">

<head>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stranger Things Task Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --red: #ff0000;
            --dark-red: #590000;
            --task-font-size: 1.1rem;
            --task-font-family: 'Courier New', Courier, monospace;

            /* Original colors */
            --color-red: #ff0000;
            --color-yellow: #ffeb3b;
            --color-blue: #1e00ff;
            --color-green: #00ff00;
            --color-grey: #666666;

            /* NEW: 5 additional colors */
            --color-orange: #ff9100;
            --color-purple: #d500f9;
            --color-cyan: #00e5ff;
            --color-lime: #76ff03;
            --color-white: #ffffff;
        }

        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* LOCK WINDOW SCROLL */
            position: fixed;
            /* PREVENT RUBBER BANDING */
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- –§–û–ù --- */
        .bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-image: url('https://images.cgames.de/images/gamestar/290/stranger-things_6000665.jpg');
            background-size: cover;
            background-position: center;
            filter: contrast(1.1) brightness(0.7);
            transition: filter 0.2s;
        }

        body.invoking .bg-layer {
            filter: contrast(1.5) brightness(0.2) sepia(0.5) hue-rotate(-10deg);
            transition: filter 3s ease;
        }

        .overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.6) 50%, rgba(0, 0, 0, 0.9) 100%);
        }

        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            opacity: 0.2;
        }

        /* --- –≠–§–§–ï–ö–¢–´ --- */
        #spores-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            transition: opacity 2s ease;
            overflow: hidden;
        }

        body.music-active #spores-container {
            opacity: 1;
        }

        body.invoking #spores-container {
            opacity: 1 !important;
            transition: opacity 0.5s ease;
        }

        .spore {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.9);
        }

        @keyframes fall {
            0% {
                top: -10%;
                opacity: 0;
            }

            10%,
            90% {
                opacity: 0.9;
            }

            100% {
                top: 110%;
                opacity: 0;
            }
        }

        @keyframes sway {
            0% {
                transform: translateX(0px);
            }

            100% {
                transform: translateX(25px);
            }
        }

        #lightning {
            position: fixed;
            inset: 0;
            z-index: 4;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.15);
            mix-blend-mode: hard-light;
            opacity: 0;
        }

        .flash-now {
            animation: thunder-strike 0.6s ease-out;
        }

        @keyframes thunder-strike {

            0%,
            100% {
                opacity: 0;
            }

            5% {
                opacity: 0.8;
            }

            15% {
                opacity: 0.6;
            }
        }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #app-ui {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* ENABLE CONTAINER SCROLL */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            /* SMOOTH IOS SCROLL */
        }

        @keyframes flicker {

            0%,
            100% {
                opacity: 1;
                text-shadow: 0 0 20px var(--red);
            }

            50% {
                opacity: 0.8;
                text-shadow: 0 0 5px var(--dark-red);
            }
        }

        #workspace {
            display: block;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--dark-red);
        }

        .header h2 {
            color: var(--red);
            margin: 0;
            font-size: 2rem;
            text-transform: uppercase;
            text-shadow: 0 0 10px #000;
            animation: flicker 4s infinite alternate;
            cursor: pointer;
            transition: all 3s ease;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body.invoking .header h2 {
            color: #1a0000;
            text-shadow: 0 0 5px #000;
            transform: scale(0.98);
        }

        /* –ë–õ–û–ö–ò */
        .control-box {
            background: rgba(20, 0, 0, 0.85);
            border: 1px solid var(--dark-red);
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        /* –†–∞–¥–∏–æ */
        .channel-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .ch-btn {
            background: #111;
            border: 1px solid #444;
            color: #777;
            padding: 8px 0;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .ch-btn.active {
            border-color: var(--red);
            color: var(--red);
            background: rgba(255, 0, 0, 0.2);
        }

        .play-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .play-btn.playing {
            background: var(--red);
            color: #000;
        }

        /* Radio Collapsible Panel */
        .radio-header {
            cursor: pointer;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-bottom: 2px solid var(--dark-red);
            color: var(--red);
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .radio-header:hover {
            border-bottom-color: var(--red);
            text-shadow: 0 0 8px var(--red);
        }

        .radio-header svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            transition: transform 0.3s ease;
        }

        .radio-header.collapsed svg {
            transform: rotate(-90deg);
        }

        .radio-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .radio-content.hidden {
            max-height: 0;
            opacity: 0;
        }

        /* --- –¢–ê–ô–ú–ï–† --- */
        .timer-display-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #444;
        }

        .timer-digits {
            font-size: 3.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 15px var(--red);
            letter-spacing: 2px;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            text-align: center;
            width: 100%;
        }

        .timer-controls-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

        .t-btn-text {
            background: transparent;
            border: 1px solid var(--dark-red);
            color: #ccc;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 12px 0;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
            width: 100%;
        }

        .t-btn-text:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .t-btn-text.active {
            background: var(--red);
            color: #000;
            border-color: var(--red);
        }

        .timer-icons-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            width: 100%;
        }

        .t-btn-icon {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 0;
            -webkit-tap-highlight-color: transparent;
            width: 100%;
            min-width: 0;
        }

        /* –ñ–ï–°–¢–ö–ò–ô –†–ê–ó–ú–ï–† –î–õ–Ø –ò–ö–û–ù–û–ö */
        .t-btn-icon svg {
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            flex-shrink: 0;
        }

        @media (hover: hover) {
            .t-btn-icon:hover {
                border-color: var(--red);
                color: var(--red);
            }
        }

        .t-btn-icon.active {
            border-color: var(--red) !important;
            color: var(--red) !important;
            background: rgba(255, 0, 0, 0.1);
            box-shadow: 0 0 5px var(--dark-red);
        }

        .t-btn-icon.active svg {
            stroke-width: 2.5;
            filter: drop-shadow(0 0 2px var(--red));
        }

        .timer-row-settings {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-top: 1px dashed #333;
            padding-top: 15px;
            margin-top: 15px;
        }

        .timer-row-settings.visible {
            display: grid;
        }

        .setting-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            padding: 8px 10px;
        }

        .setting-cell label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .setting-cell select {
            width: 50px;
            background: transparent;
            border: none;
            color: var(--red);
            font-weight: bold;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            text-align: right;
            text-align-last: right;
            cursor: pointer;
        }

        .setting-cell select::-ms-expand {
            display: none;
        }

        .status-badge {
            font-size: 0.75rem;
            color: #555;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .status-stripe {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 0 5px;
            width: 100%;
        }

        .air-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 1px;
            color: #555;
        }

        .air-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--red);
            box-shadow: 0 0 5px var(--red);
        }

        .air-dot.on {
            background-color: var(--color-green);
            box-shadow: 0 0 5px var(--color-green);
        }

        /* –í–≤–æ–¥ –∑–∞–¥–∞—á */
        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .input-row {
            display: flex;
            position: relative;
            gap: 5px;
            margin-bottom: 30px;
        }

        #task-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-bottom: 2px solid var(--dark-red);
            color: #fff;
            font-size: 1.2rem;
            padding: 15px;
            padding-right: 60px;
            outline: none;
        }

        .add-btn {
            width: 60px;
            background: transparent;
            border: 1px solid var(--dark-red);
            color: var(--red);
            font-size: 2.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
        }

        .add-btn:active {
            background: var(--red);
            color: #000;
        }

        .new-task-colors {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-right: 5px;
            margin-top: -20px;
            margin-bottom: 20px;
        }

        .new-color-opt {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid transparent;
            opacity: 0.4;
            transition: 0.2s;
        }

        .new-color-opt.selected {
            opacity: 1;
            transform: scale(1.2);
            border-color: #fff;
            box-shadow: 0 0 8px currentColor;
        }

        /* –°–ø–∏—Å–∫–∏ */
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .task-item {
            background: rgba(20, 20, 20, 0.85);
            border-left: 4px solid var(--red);
            margin-bottom: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            touch-action: none;
            position: relative;
            overflow: hidden;
        }

        .task-item.border-red {
            border-left-color: var(--color-red);
        }

        .task-item.border-yellow {
            border-left-color: var(--color-yellow);
        }

        .task-item.border-blue {
            border-left-color: var(--color-blue);
        }

        .task-item.border-green {
            border-left-color: var(--color-green);
        }

        .task-item.border-grey {
            border-left-color: var(--color-grey);
        }

        /* NEW: Border classes for 5 new colors */
        .task-item.border-orange {
            border-left-color: var(--color-orange);
        }

        .task-item.border-purple {
            border-left-color: var(--color-purple);
        }

        .task-item.border-cyan {
            border-left-color: var(--color-cyan);
        }

        .task-item.border-lime {
            border-left-color: var(--color-lime);
        }

        .task-item.border-white {
            border-left-color: var(--color-white);
        }

        .task-text {
            flex: 1;
            font-size: var(--task-font-size);
            font-family: var(--task-font-family);
            color: #ffffff !important;
            font-weight: 800;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 0.5px;
            z-index: 2;
        }

        .task-item.completed {
            opacity: 0.6;
            border-left-color: #444 !important;
            background: rgba(10, 10, 10, 0.8);
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #999 !important;
            text-shadow: none;
            font-weight: normal;
        }

        .checkbox {
            width: 26px;
            height: 26px;
            border: 2px solid var(--dark-red);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
        }

        .completed .checkbox {
            background: var(--red);
            border-color: var(--red);
        }

        .btn-action {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: #555;
            padding: 0 10px;
            cursor: pointer;
            z-index: 2;
        }

        .btn-edit:hover {
            color: #fff;
        }

        .btn-del:hover {
            color: var(--red);
        }

        .sortable-ghost {
            opacity: 0;
        }

        .sortable-drag {
            background: #000;
            border: 2px solid var(--red);
            opacity: 1 !important;
            transform: scale(1.05);
            z-index: 100;
            transition: none !important;
        }

        .list-title {
            color: #888;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px #000;
            text-transform: uppercase;
            font-weight: bold;
        }

        #completed-list {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px dashed #333;
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ó–ê–ú–ï–¢–û–ö (NOTES) --- */
        #notes-modal .modal-box {
            width: 85%;
            max-width: 760px;
            height: 80vh;
            padding: 0;
            border: 3px double var(--red);
            position: relative;
            background: #000;
        }

        .notes-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .notes-toolbar {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
            border-bottom: 1px solid var(--dark-red);
            background: rgba(20, 0, 0, 0.9);
            align-items: center;
        }

        .toolbar-row {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .toolbar-btn {
            background: #111;
            border: 1px solid #444;
            color: #ccc;
            padding: 5px 10px;
            font-weight: bold;
            cursor: pointer;
            min-width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:active {
            background: var(--red);
            color: #000;
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .toolbar-select {
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 5px;
            outline: none;
        }

        /* –û–±–ª–∞—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ - –ú–Ø–¢–ê–Ø –ë–£–ú–ê–ì–ê */
        #notes-editor {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            outline: none;
            font-family: 'Courier New', Courier, monospace;
            color: #eee;
            line-height: 1.5;
            background-color: #222;
            background-image: url('https://images.unsplash.com/photo-1574169208507-84376194878b?q=80&w=1000&auto=format&fit=crop');
            background-size: cover;
            background-blend-mode: multiply;
            box-shadow: inset 0 0 100px 40px #000;
            caret-color: var(--red);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∑–∞–º–µ—Ç–æ–∫ */
        .checklist-item {
            display: flex;
            align-items: flex-start;
            /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
            margin: 5px 0;
        }

        .checklist-item input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: var(--red);
            cursor: pointer;
            margin-top: 4px;
            /* –ü–æ–ø—Ä–∞–≤–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
        }

        /* –í–ê–ñ–ù–û: span –¥–ª—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã Enter —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
        .checklist-item span {
            flex: 1;
            outline: none;
            min-height: 1.5em;
            word-break: break-word;
        }

        .notes-footer {
            padding: 10px;
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--dark-red);
            background: #111;
        }

        .notes-close-x {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #000;
            border: 2px solid var(--red);
            color: var(--red);
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            z-index: 10;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-box {
            background: #111;
            border: 2px solid var(--red);
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px var(--dark-red);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-title {
            color: var(--red);
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 1px;
        }

        .edit-textarea {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-family: inherit;
            resize: none;
        }

        .range-slider {
            width: 100%;
            -webkit-appearance: none;
            background: #333;
            height: 6px;
            outline: none;
            margin: 25px 0;
            border-radius: 3px;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--red);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--red);
        }

        .font-select {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            cursor: pointer;
        }

        .color-options {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 20px 0;
        }

        .color-opt {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-opt.selected {
            transform: scale(1.3);
            border-color: #fff;
            box-shadow: 0 0 15px currentColor;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: 1px solid #444;
            background: transparent;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-btn.primary {
            border-color: var(--red);
            color: var(--red);
        }

        .modal-btn:active {
            background: #333;
        }

        .alarm-msg {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
            color: #fff;
            line-height: 1.4;
        }

        /* TOAST NOTIFICATION */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 0, 0, 0.9);
            color: #fff;
            padding: 12px 24px;
            border: 1px solid var(--red);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            box-shadow: 0 0 10px var(--dark-red);
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* --- SUPABASE AUTH SECTION (RADIO FREQUENCY STYLE) --- */
        .auth-section {
            border: 2px solid var(--dark-red);
            padding: 15px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .auth-title {
            color: var(--red);
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .auth-status {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #444;
            background: #000;
        }

        .status-offline {
            color: #ff0000;
            animation: blink-red 1s infinite;
        }

        .status-online {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        @keyframes blink-red {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .auth-input {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-family: inherit;
            text-transform: uppercase;
            outline: none;
        }

        .auth-input::placeholder {
            color: #555;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: 1px;
            transition: 0.2s;
        }

        .auth-btn:active {
            background: var(--red);
            color: #000;
        }

        .auth-info {
            color: #888;
            font-size: 0.75rem;
            text-align: center;
            margin: 10px 0;
            line-height: 1.4;
        }

        .auth-user-email {
            color: #00ff00;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--red);
            color: var(--red);
            padding: 8px 15px;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 1px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .sync-indicator.visible {
            opacity: 1;
        }

        /* ========== THE VOID MODE (–†–ï–ñ–ò–ú –§–û–ö–£–°–ò–†–û–í–ö–ò) ========== */
        /* –ó–∞—Ç–µ–º–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π overlay –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ */
        body.void-mode .overlay {
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.9) 50%, rgba(0, 0, 0, 0.95) 100%);
            transition: background 0.8s ease;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–≤–ª–µ–∫–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        body.void-mode .header,
        body.void-mode #radio-control-box,
        body.void-mode .channel-row,
        body.void-mode .play-btn,
        body.void-mode .input-wrapper,
        body.void-mode .list-title,
        body.void-mode #completed-section {
            display: none !important;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π */
        body.void-mode #active-list li:not(:first-child) {
            display: none;
        }

        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É */
        body.void-mode #active-list li:first-child {
            font-size: 1.3rem;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            border-left-width: 6px;
            transition: all 0.5s ease;
            margin-bottom: 30px;
        }

        body.void-mode #active-list li:first-child .task-text {
            font-size: 1.3em;
            text-shadow: 3px 3px 0 #000, 0 0 15px rgba(255, 0, 0, 0.3);
        }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º workspace –≤ —Ä–µ–∂–∏–º–µ void */
        body.void-mode #workspace {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* –¢–∞–π–º–µ—Ä –∏ –∫–Ω–æ–ø–∫–∏ - —É—Å–∏–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ */
        body.void-mode .control-box:nth-of-type(2) {
            background: rgba(20, 0, 0, 0.95);
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.3);
            transition: all 0.5s ease;
        }

        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –≤ —Ä–µ–∂–∏–º–µ void */
        body.void-mode .timer-digits {
            font-size: 4.5rem;
            text-shadow: 0 0 25px var(--red), 0 0 50px var(--red);
            transition: all 0.5s ease;
        }
    </style>

</head>

<body>

    <div class="bg-layer" id="bg-layer"></div>
    <div class="overlay"></div>
    <div class="scanlines"></div>
    <div id="lightning"></div>
    <div id="spores-container"></div>

    <div id="app-ui">
        <div id="workspace">
            <div class="header">
                <h2 id="main-header" onmousedown="startInvocation()" onmouseup="stopInvocation()"
                    onmouseleave="stopInvocation()" ontouchstart="startInvocation(event)" ontouchend="stopInvocation()">
                    –°–ü–ò–°–û–ö –ó–ê–î–ê–ß</h2>
            </div>

            <!-- –ë–õ–û–ö –†–ê–î–ò–û -->
            <div class="control-box" id="radio-control-box">
                <div class="radio-header collapsed" onclick="toggleRadioPanel()">
                    üì° –ß–ê–°–¢–û–¢–´ –≠–§–ò–†–ê
                    <svg viewBox="0 0 24 24">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
                <div class="radio-content hidden">
                    <div class="channel-row">
                        <div class="ch-btn active" onclick="setCh(0)">1</div>
                        <div class="ch-btn" onclick="setCh(1)">2</div>
                        <div class="ch-btn" onclick="setCh(2)">3</div>
                        <div class="ch-btn" onclick="setCh(3)">4</div>
                        <div class="ch-btn" onclick="setCh(4)">5</div>
                    </div>
                    <div class="channel-row">
                        <div class="ch-btn" onclick="setCh(5)">6</div>
                        <div class="ch-btn" onclick="setCh(6)">7</div>
                        <div class="ch-btn" onclick="setCh(7)">8</div>
                        <div class="ch-btn" onclick="setCh(8)">9</div>
                        <div class="ch-btn" onclick="setCh(9)">10</div>
                    </div>
                    <button class="play-btn" id="play-btn" onclick="toggleAudio()">–ù–ê–ß–ê–¢–¨ –≠–§–ò–†</button>
                </div>
            </div>

            <!-- –ë–õ–û–ö –ü–û–ú–û–î–û–†–û -->
            <div class="control-box">
                <!-- 1. –¶–ò–§–†–´ –¢–ê–ô–ú–ï–†–ê (–≠–¢–ê–ñ 1) -->
                <div class="timer-display-row">
                    <div class="timer-digits" id="timer">25:00</div>
                </div>

                <!-- 2. –û–°–ù–û–í–ù–´–ï –ö–ù–û–ü–ö–ò (–≠–¢–ê–ñ 2) -->
                <div class="timer-controls-row">
                    <button class="t-btn-text" id="t-start-btn" onclick="toggleTimer()">–°–¢–ê–†–¢</button>
                    <button class="t-btn-text" onclick="fullReset()">–°–ë–†–û–°</button>
                    <button class="t-btn-text" onclick="openNotes()">–ó–ê–ú–ï–¢–ö–ò</button>
                </div>

                <!-- 3. –ò–ö–û–ù–ö–ò (–≠–¢–ê–ñ 3 - –†–û–í–ù–ê–Ø –°–ï–¢–ö–ê) -->
                <div class="timer-icons-row">
                    <!-- –°–ª–µ–¥. —ç—Ç–∞–ø -->
                    <button class="t-btn-icon" title="–°–ª–µ–¥. —ç—Ç–∞–ø" onclick="forceNextStep()">
                        <svg viewBox="0 0 24 24">
                            <path d="M5 4l10 8l-10 8V4z" />
                            <rect x="17" y="4" width="2" height="16" />
                        </svg>
                    </button>
                    <!-- –í–µ–∫–Ω–∞ -->
                    <button class="t-btn-icon active" id="vecna-toggle" onclick="toggleVecna()">
                        <svg viewBox="0 0 24 24">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" />
                        </svg>
                    </button>
                    <!-- –≠–∫—Ä–∞–Ω -->
                    <button class="t-btn-icon" id="wakelock-toggle" onclick="toggleWakeLock()">
                        <svg id="icon-screen" viewBox="0 0 24 24">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2" stroke="currentColor" fill="none"
                                stroke-width="2" />
                            <line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2" />
                        </svg>
                    </button>

                    <!-- –°–∂–µ—á—å –ê—Ä—Ö–∏–≤ -->
                    <button class="t-btn-icon" title="–°–ñ–ï–ß–¨ –ê–†–•–ò–í" onclick="openBurnModal()">
                        <svg viewBox="0 0 24 24" style="fill: currentColor; stroke: none;">
                            <path
                                d="M12 23c-3.037 0-5.5-2.463-5.5-5.5 0-2.702 1.796-4.577 2.77-5.478.294-.272.53-.48.73-.663V8.5c0-.276.224-.5.5-.5s.5.224.5.5v2.859c.2.183.436.391.73.663.974.901 2.77 2.776 2.77 5.478 0 3.037-2.463 5.5-5.5 5.5zm0-1c2.485 0 4.5-2.015 4.5-4.5 0-2.235-1.521-3.843-2.395-4.661-.318-.297-.602-.562-.855-.805-.253.243-.537.508-.855.805C11.521 13.657 10 15.265 10 17.5c0 2.485 2.015 4.5 4.5 4.5zM9 11.5c0 .276-.224.5-.5.5s-.5-.224-.5-.5c0-1.93-1.57-3.5-3.5-3.5-.276 0-.5-.224-.5-.5s.224-.5.5-.5c2.481 0 4.5 2.019 4.5 4.5zm11-4c0 .276-.224.5-.5.5s-.5-.224-.5-.5c0-1.93-1.57-3.5-3.5-3.5-.276 0-.5-.224-.5-.5s.224-.5.5-.5c2.481 0 4.5 2.019 4.5 4.5zM7 6.5c0 .276-.224.5-.5.5s-.5-.224-.5-.5C6 4.019 7.519 2.5 10 2.5c.276 0 .5.224.5.5s-.224.5-.5.5C8.07 3.5 7 4.57 7 6.5z" />
                        </svg>
                    </button>

                    <!-- –ö–Ω–æ–ø–∫–∞ —á–∞—Å–æ–≤ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                    <button class="t-btn-icon" id="timer-settings-toggle" onclick="toggleTimerSettings()">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </button>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–®–µ—Å—Ç–µ—Ä–µ–Ω–∫–∞) -->
                    <button class="t-btn-icon" onclick="openSettingsModal()">
                        <svg viewBox="0 0 24 24" style="fill: currentColor; stroke: none;">
                            <path
                                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
                        </svg>
                    </button>
                </div>

                <!-- 5. –ù–ê–°–¢–†–û–ô–ö–ò (–°–ö–†–´–¢–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ) -->
                <div class="timer-row-settings" id="timer-settings-panel">
                    <div class="setting-cell">
                        <label>–†–ê–ë–û–¢–ê:</label>
                        <select id="work-time" onchange="updateSettings()"></select>
                    </div>
                    <div class="setting-cell">
                        <label>–û–¢–î–´–•:</label>
                        <select id="break-time" onchange="updateSettings()"></select>
                    </div>
                    <div class="setting-cell">
                        <label>–ë. –û–¢–î–´–•:</label>
                        <select id="long-break-time" onchange="updateSettings()"></select>
                    </div>
                    <div class="setting-cell">
                        <label>–¶–ò–ö–õ–´:</label>
                        <select id="cycles-target" onchange="updateSettings()"></select>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å —Ü–∏–∫–ª–∞ –í–°–ï–ì–î–ê –í–ò–î–ï–ù + ON/OFF AIR -->
                <div class="status-stripe">
                    <div class="status-badge" id="cycle-status">–¶–ò–ö–õ 1 / 4</div>
                    <div class="air-status">
                        <span class="air-dot" id="main-air-dot"></span>
                        <span id="main-air-text">OFF AIR</span>
                    </div>
                </div>
            </div>

            <div class="input-wrapper">
                <div class="input-row">
                    <input type="text" id="task-input" placeholder="–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê..."
                        onkeydown="if(event.key==='Enter') addTask()">
                    <button class="add-btn" onclick="addTask()">+</button>
                </div>
                <!-- –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ -->
                <div class="new-task-colors">
                    <div class="new-color-opt" style="background:var(--color-grey)" onclick="selectNewColor('grey')"
                        id="new-col-grey"></div>
                    <div class="new-color-opt selected" style="background:var(--color-red)"
                        onclick="selectNewColor('red')" id="new-col-red"></div>
                    <div class="new-color-opt" style="background:var(--color-yellow)" onclick="selectNewColor('yellow')"
                        id="new-col-yellow"></div>
                    <div class="new-color-opt" style="background:var(--color-blue)" onclick="selectNewColor('blue')"
                        id="new-col-blue"></div>
                    <div class="new-color-opt" style="background:var(--color-green)" onclick="selectNewColor('green')"
                        id="new-col-green"></div>
                    <!-- NEW: 5 additional colors -->
                    <div class="new-color-opt" style="background:var(--color-orange)" onclick="selectNewColor('orange')"
                        id="new-col-orange"></div>
                    <div class="new-color-opt" style="background:var(--color-purple)" onclick="selectNewColor('purple')"
                        id="new-col-purple"></div>
                    <div class="new-color-opt" style="background:var(--color-cyan)" onclick="selectNewColor('cyan')"
                        id="new-col-cyan"></div>
                    <div class="new-color-opt" style="background:var(--color-lime)" onclick="selectNewColor('lime')"
                        id="new-col-lime"></div>
                    <div class="new-color-opt" style="background:var(--color-white)" onclick="selectNewColor('white')"
                        id="new-col-white"></div>
                </div>
            </div>

            <div class="list-title">–ê–ö–¢–ò–í–ù–´–ï</div>
            <ul id="active-list"></ul>

            <div id="completed-section">
                <div class="list-title" style="margin-top: 30px;">–ê–†–•–ò–í</div>
                <ul id="completed-list"></ul>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ó–ê–ú–ï–¢–û–ö -->
    <div id="notes-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="notes-close-x" onclick="checkNotesClose()">X</button>
            <div class="notes-container">
                <div class="notes-toolbar">
                    <div class="toolbar-row">
                        <button class="toolbar-btn" onclick="formatDoc('bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
                        <button class="toolbar-btn" onclick="formatDoc('italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
                        <button class="toolbar-btn" onclick="formatDoc('underline')"
                            title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å"><u>U</u></button>

                        <!-- –ö–Ω–æ–ø–∫–∞ –ß–µ–∫–ª–∏—Å—Ç -->
                        <button class="toolbar-btn" onclick="insertChecklist()" title="–ß–µ–∫–ª–∏—Å—Ç">‚òë</button>

                        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è -->
                        <button class="toolbar-btn" onclick="formatDoc('justifyLeft')" title="–°–ª–µ–≤–∞">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z" />
                            </svg>
                        </button>
                        <button class="toolbar-btn" onclick="formatDoc('justifyCenter')" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">
                            <svg viewBox="0 0 24 24">
                                <path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z" />
                            </svg>
                        </button>
                        <button class="toolbar-btn" onclick="formatDoc('justifyRight')" title="–°–ø—Ä–∞–≤–∞">
                            <svg viewBox="0 0 24 24">
                                <path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z" />
                            </svg>
                        </button>
                    </div>

                    <div class="toolbar-row">
                        <select class="toolbar-select" onchange="formatDoc('fontName', this.value)">
                            <option value="Courier New">Courier</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times</option>
                        </select>

                        <select class="toolbar-select" onchange="formatDoc('fontSize', this.value)">
                            <option value="3">–ù–æ—Ä–º</option>
                            <option value="5">–ö—Ä—É–ø–Ω–æ</option>
                            <option value="7">–û–≥—Ä–æ–º–Ω–æ</option>
                        </select>

                        <select class="toolbar-select" onchange="formatDoc('foreColor', this.value)">
                            <option value="white">–ë–µ–ª—ã–π</option>
                            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                            <option value="yellow">–ñ–µ–ª—Ç—ã–π</option>
                            <option value="#888">–°–µ—Ä—ã–π</option>
                        </select>
                    </div>
                </div>

                <!-- –†–µ–¥–∞–∫—Ç–æ—Ä -->
                <div id="notes-editor" contenteditable="true"></div>

                <div class="notes-footer">
                    <button class="modal-btn" onclick="checkNotesClose()">–ó–ê–ö–†–´–¢–¨ –ë–ï–ó –°–û–•–†–ê–ù–ï–ù–ò–Ø</button>
                    <button class="modal-btn primary" onclick="saveNotes()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">–ù–ê–°–¢–†–û–ô–ö–ò –°–ò–°–¢–ï–ú–´</div>

            <!-- SUPABASE AUTH SECTION -->
            <div class="auth-section" id="auth-section">
                <div class="auth-title">‚ö° –ß–ê–°–¢–û–¢–ê SYNC ‚ö°</div>
                <div class="auth-status" id="auth-status">
                    <span class="status-offline">üî¥ –í–ù–ï –≠–§–ò–†–ê (OFF AIR)</span>
                </div>

                <!-- State: Not Logged In -->
                <div id="auth-login-form" style="display:none;">
                    <input type="email" class="auth-input" id="auth-email" placeholder="–í–í–ï–î–ò–¢–ï –ü–û–ó–´–í–ù–û–ô (EMAIL)">
                    <button class="auth-btn" onclick="sendOTP()">–£–°–¢–ê–ù–û–í–ò–¢–¨ –°–í–Ø–ó–¨</button>
                </div>

                <!-- State: Waiting for Code -->
                <div id="auth-code-form" style="display:none;">
                    <div class="auth-info" id="auth-email-sent">–®–∏—Ñ—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ <span id="sent-email"></span>
                    </div>
                    <input type="text" class="auth-input" id="auth-code" placeholder="–ö–û–î –î–û–°–¢–£–ü–ê (6 –¶–ò–§–†)"
                        maxlength="6">
                    <button class="auth-btn" onclick="verifyOTP()">–ü–†–ò–ï–ú (VERIFY)</button>
                </div>

                <!-- State: Logged In -->
                <div id="auth-logged-in" style="display:none;">
                    <div class="auth-user-email" id="auth-user-email"></div>
                    <button class="auth-btn" onclick="logout()">–ö–û–ù–ï–¶ –°–í–Ø–ó–ò (LOGOUT)</button>
                </div>
            </div>

            <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">–†–ê–ó–ú–ï–† –®–†–ò–§–¢–ê</div>
            <input type="range" class="range-slider" id="font-size-slider" min="12" max="32" step="1"
                oninput="updateFontSize(this.value)">
            <div style="color:#aaa; font-size:0.8rem; margin:15px 0 5px;">–°–¢–ò–õ–¨ –®–†–ò–§–¢–ê</div>
            <select id="font-family-select" class="font-select" onchange="updateFontFamily(this.value)">
                <option value="'Courier New', Courier, monospace">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (Default)</option>
                <option value="'Share Tech Mono', monospace">–¢–µ—Ä–º–∏–Ω–∞–ª –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏</option>
                <option value="'Times New Roman', serif">–ì–∞–∑–µ—Ç–Ω–∞—è –í—ã—Ä–µ–∑–∫–∞</option>
                <option value="'Arial Black', sans-serif">–°–æ–≤–µ—Ç—Å–∫–∏–π –ü–ª–∞–∫–∞—Ç</option>
                <option value="'Lucida Console', monospace">–¶–∏—Ñ—Ä–æ–≤–æ–π –ö–æ–¥</option>
            </select>
            <div style="text-align:center; color:#fff; font-size:1.1rem; margin-top:20px;" id="font-preview">–¢–ï–ö–°–¢
                –ü–†–ò–ú–ï–†</div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSettingsModal()">–ó–ê–ö–†–´–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï</div>
            <textarea id="edit-task-input" class="edit-textarea"></textarea>
            <div style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">–¶–í–ï–¢ –û–ö–ê–ù–¢–û–í–ö–ò</div>
            <div class="color-options">
                <div class="color-opt" style="background:var(--color-grey)" onclick="selectColor('grey')" id="col-grey">
                </div>
                <div class="color-opt" style="background:var(--color-red)" onclick="selectColor('red')" id="col-red">
                </div>
                <div class="color-opt" style="background:var(--color-yellow)" onclick="selectColor('yellow')"
                    id="col-yellow"></div>
                <div class="color-opt" style="background:var(--color-blue)" onclick="selectColor('blue')" id="col-blue">
                </div>
                <div class="color-opt" style="background:var(--color-green)" onclick="selectColor('green')"
                    id="col-green"></div>
                <!-- NEW: 5 additional colors -->
                <div class="color-opt" style="background:var(--color-orange)" onclick="selectColor('orange')"
                    id="col-orange">
                </div>
                <div class="color-opt" style="background:var(--color-purple)" onclick="selectColor('purple')"
                    id="col-purple">
                </div>
                <div class="color-opt" style="background:var(--color-cyan)" onclick="selectColor('cyan')" id="col-cyan">
                </div>
                <div class="color-opt" style="background:var(--color-lime)" onclick="selectColor('lime')" id="col-lime">
                </div>
                <div class="color-opt" style="background:var(--color-white)" onclick="selectColor('white')"
                    id="col-white">
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeEditModal()">–û–¢–ú–ï–ù–ê</button>
                <button class="modal-btn primary" onclick="saveEditTask()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –£–î–ê–õ–ï–ù–ò–Ø -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="font-size: 1.1rem; line-height: 1.4;">–î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –ê–ö–¢–ò–í–ù–£–Æ
                –ó–ê–î–ê–ß–£?</div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeDeleteModal()">–ù–ï–¢</button>
                <button class="modal-btn primary" onclick="confirmDelete()">–î–ê, –£–ù–ò–ß–¢–û–ñ–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ù–ï–°–û–•–†–ê–ù–ï–ù–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
    <div id="unsaved-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="font-size: 1.2rem;">–ï–°–¢–¨ –ù–ï–°–û–•–†–ê–ù–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø</div>
            <div style="color: #ccc; text-align: center; margin-bottom: 20px;">–¢–û–ß–ù–û –í–´–ô–¢–ò?</div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeUnsavedModal()">–ù–ï–¢, –û–°–¢–ê–¢–¨–°–Ø</button>
                <button class="modal-btn primary" onclick="confirmCloseNotes()">–î–ê, –í–´–ô–¢–ò</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –°–ñ–ò–ì–ê–ù–ò–Ø –ê–†–•–ò–í–ê -->
    <div id="burn-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="font-size: 1.2rem;">–ü–†–û–¢–û–ö–û–õ: –°–ñ–ò–ì–ê–ù–ò–ï</div>
            <div style="color: #ccc; text-align: center; margin-bottom: 20px; line-height: 1.5;">
                –í–´ –¢–û–ß–ù–û –•–û–¢–ò–¢–ï –£–ù–ò–ß–¢–û–ñ–ò–¢–¨ –í–°–ï –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò?<br>–≠–¢–û –ù–ï–û–ë–†–ê–¢–ò–ú–û.
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeBurnModal()">–û–¢–ú–ï–ù–ê</button>
                <button class="modal-btn primary" onclick="confirmBurnArchive()">–°–ñ–ï–ß–¨</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ì–û–ù–ì–ê -->
    <div id="alarm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="color:var(--red); font-size:1.5rem;">–í–ù–ò–ú–ê–ù–ò–ï</div>
            <div id="alarm-message" class="alarm-msg"></div>
            <div class="modal-actions" style="flex-direction:column; gap:15px;">
                <button class="modal-btn primary" style="font-size:1.2rem; padding:15px;"
                    onclick="continueCycle()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                <div style="display:flex; gap:10px; width:100%">
                    <button class="modal-btn" onclick="stopGongSound()">–°–¢–û–ü –ó–í–£–ö</button>
                    <button class="modal-btn" style="border-color: #666; color: #aaa;"
                        onclick="endCycleFromModal()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–£–î–ò–û -->
    <audio id="audio" loop></audio>
    <!-- Silent Loop for iOS Background Timer -->
    <audio id="silence-loop" loop
        src="data:audio/mp3;base64,//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAP//OEAAAAAAAAAAAAAAAAAAAAAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAAAAAAAAAAAAACCAAAAAAAAABAAAA//OECQAAAAABIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//OECQAAAAABIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"></audio>
    <audio id="vecna-sfx"
        src="https://www.myinstants.com/media/sounds/stranger-things-vecna-grandfather-clock.mp3"></audio>
    <audio id="gong-sfx" src="https://www.myinstants.com/media/sounds/undertakers-bell-1.mp3" loop></audio>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="sync-indicator">–û–¢–ü–†–ê–í–ö–ê...</div>

    <script>
        const DB_KEY = 'STRANGER_THINGS_GOLD_DB';
        const LEGACY_KEYS = ['stas_tasks_final', 'stas_tasks_final_elite', 'stas_tasks_elite'];

        // ========== SUPABASE SETUP ==========
        let supabaseClient = null;
        let currentUser = null;
        let realtimeChannel = null;
        let notesRealtimeChannel = null;
        let pendingEmail = '';

        // Initialize Supabase after page loads
        function initSupabase() {
            try {
                if (window.supabase) {
                    const supabaseUrl = 'https://jiovbimhoitawrtkqxmp.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppb3ZiaW1ob2l0YXdydGtxeG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMDc4NzMsImV4cCI6MjA4MzU4Mzg3M30.5-sBNX4Z5HcmMClmaySgoDDT2IDw3swcyYLZo3GnMCM';
                    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase initialized successfully');
                } else {
                    console.warn('Supabase library not loaded');
                }
            } catch (error) {
                console.error('Supabase init error:', error);
            }
        }

        let currentEditId = null;
        let selectedColor = 'red';
        let newSelectedColor = 'red';
        let currentFontSize = 1.1;
        let currentFontFamily = "'Courier New', Courier, monospace";
        let taskToDeleteId = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è

        function loadTasks() {
            let data = [];
            try {
                const savedFontSize = localStorage.getItem('stas_font_size');
                if (savedFontSize) {
                    currentFontSize = parseFloat(savedFontSize);
                    document.documentElement.style.setProperty('--task-font-size', currentFontSize + 'rem');
                }
                const savedFontFamily = localStorage.getItem('stas_font_family');
                if (savedFontFamily) {
                    currentFontFamily = savedFontFamily;
                    document.documentElement.style.setProperty('--task-font-family', currentFontFamily);
                }
                const saved = localStorage.getItem(DB_KEY);
                if (saved) {
                    data = JSON.parse(saved);
                } else {
                    for (let key of LEGACY_KEYS) {
                        const legacyData = localStorage.getItem(key);
                        if (legacyData) {
                            try {
                                const parsed = JSON.parse(legacyData);
                                if (Array.isArray(parsed) && parsed.length > 0) {
                                    data = parsed; break;
                                }
                            } catch (e) { }
                        }
                    }
                    if (data.length > 0) localStorage.setItem(DB_KEY, JSON.stringify(data));
                }
            } catch (e) { }
            return data || [];
        }

        let tasks = loadTasks();

        const songs = [
            "https://hawkins-task.vercel.app/LOrchestra_Cinematique_Michael_Stein_Kyle_Dixon_-_Stranger_Things_Main_Theme_53151697.mp3",
            "https://hawkins-task.vercel.app/Michael_Stein_Kyle_Dixon_-_Kids_50273473.mp3",
            "https://hawkins-task.vercel.app/Kate_Bush_-_Running_Up_That_Hill_A_Deal_With_God_48002274.mp3",
            "https://hawkins-task.vercel.app/Journey_-_Separate_Ways_Worlds_Apart_48054280.mp3",
            "https://hawkins-task.vercel.app/Scorpions_-_Rock_You_Like_a_Hurricane_47954772.mp3",
            "https://hawkins-task.vercel.app/Bon_Jovi_-_Runaway_47852333.mp3",
            "https://hawkins-task.vercel.app/The_Clash_-_Should_I_Stay_or_Should_I_Go_47992439.mp3",
            "https://hawkins-task.vercel.app/The_Police_-_Every_Breath_You_Take_47835969.mp3",
            "https://hawkins-task.vercel.app/Foreigner_-_Cold_As_Ice_47969496.mp3",
            "https://hawkins-task.vercel.app/Cutting_Crew_-_Died_In_Your_Arms_48076414.mp3"
        ];
        let curCh = 0;

        const sfxClick = new Audio("https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3");
        const sfxDel = new Audio("https://assets.mixkit.co/active_storage/sfx/2857/2857-preview.mp3");

        function playSfx(type) {
            const s = type === 'click' ? sfxClick : sfxDel;
            s.currentTime = 0; s.volume = 0.4;
            s.play().catch(() => { });
        }

        function triggerHeaderGlitch() {
            const h = document.getElementById('main-header');
            if (h.classList.contains('glitch-active')) return;
            h.classList.add('glitch-active');
            if (Math.random() > 0.5) triggerLightning();
            setTimeout(() => { h.classList.remove('glitch-active'); }, 600);
        }

        let invokeInterval = null;
        function startInvocation(e) {
            if (e && e.type === 'touchstart') { }
            document.body.classList.add('invoking');
            triggerLightning();
            invokeInterval = setInterval(() => {
                if (Math.random() > 0.6) triggerLightning();
            }, 800);
        }
        function stopInvocation() {
            document.body.classList.remove('invoking');
            clearInterval(invokeInterval);
        }

        let wakeLock = null;
        const iconScreenOff = '<rect x="5" y="2" width="14" height="20" rx="2" ry="2" stroke="currentColor" fill="none" stroke-width="2"/><line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2"/>';
        const iconScreenOn = '<rect x="5" y="2" width="14" height="20" rx="2" ry="2" stroke="currentColor" fill="none" stroke-width="2"/><path d="M12 10v4" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="18" r="1" fill="currentColor"/>';

        async function toggleWakeLock() {
            const btn = document.getElementById('wakelock-toggle');
            const iconSvg = document.getElementById('icon-screen');
            if (!wakeLock) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    btn.classList.add('active');
                    iconSvg.innerHTML = iconScreenOn;
                    wakeLock.addEventListener('release', () => {
                        wakeLock = null;
                        btn.classList.remove('active');
                        iconSvg.innerHTML = iconScreenOff;
                    });
                } catch (err) {
                    console.error(err);
                    showToast("–ë–†–ê–£–ó–ï–† –ë–õ–û–ö–ò–†–£–ï–¢ –≠–ö–†–ê–ù");
                }
            } else {
                wakeLock.release();
                wakeLock = null;
            }
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { }
            }
        });

        // TOAST FUNCTION
        function showToast(msg) {
            let t = document.getElementById('toast-box');
            if (!t) {
                t = document.createElement('div');
                t.id = 'toast-box';
                t.className = 'toast';
                document.body.appendChild(t);
            }
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function initSelects() {
            const createOptions = (target, min, max, def) => {
                const sel = document.getElementById(target);
                sel.innerHTML = '';
                for (let i = min; i <= max; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = i;
                    if (i === def) opt.selected = true;
                    sel.appendChild(opt);
                }
            };
            createOptions('work-time', 1, 60, 25);
            createOptions('break-time', 1, 30, 5);
            createOptions('long-break-time', 1, 60, 15);
            createOptions('cycles-target', 1, 10, 4);
        }

        function toggleTimerSettings() {
            const settingsPanel = document.getElementById('timer-settings-panel');
            const toggleBtn = document.getElementById('timer-settings-toggle');
            if (settingsPanel.classList.contains('visible')) {
                settingsPanel.classList.remove('visible');
                toggleBtn.classList.remove('active');
            } else {
                settingsPanel.classList.add('visible');
                toggleBtn.classList.add('active');
            }
        }

        let timerInterval = null;
        let timeLeft = 0;
        let isWorkSession = true;
        let vecnaEnabled = true;
        let currentCycle = 1;
        let timerHistory = null;
        let timerEndTime = 0;

        function saveTimerState() {
            timerHistory = {
                timeLeft: timeLeft,
                isWorkSession: isWorkSession,
                currentCycle: currentCycle
            };
        }

        function restoreTimerState() {
            if (!timerHistory) { showToast("–ù–ï–¢ –î–ê–ù–ù–´–• –û–¢–ú–ï–ù–´"); return; }
            if (confirm("–í–ï–†–ù–£–¢–¨–°–Ø –ù–ê –®–ê–ì –ù–ê–ó–ê–î?")) {
                stopTicking();
                timeLeft = timerHistory.timeLeft;
                isWorkSession = timerHistory.isWorkSession;
                currentCycle = timerHistory.currentCycle;
                updateDisplay();
                updateCycleStatus();
            }
        }

        function forceNextStep() {
            handleTimerComplete();
        }

        function toggleVecna() {
            vecnaEnabled = !vecnaEnabled;
            const btn = document.getElementById('vecna-toggle');
            if (vecnaEnabled) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            const timeStr = `${m}:${s}`;
            document.getElementById('timer').innerText = timeStr;

            // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤–∫–ª–∞–¥–∫–∏
            document.title = `${timeStr} - –û–ß–ï–ù–¨ –°–¢–†–ê–ù–ù–´–ï –î–ï–õ–ê`;

            // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Media Session (–î–ª—è —à—Ç–æ—Ä–∫–∏/—ç–∫—Ä–∞–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: timeStr,
                    artist: isWorkSession ? "–§–û–ö–£–°–ò–†–û–í–ö–ê" : "–û–¢–î–´–•",
                    album: "HAWKINS LAB",
                    artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/3565/3565099.png', sizes: '512x512', type: 'image/png' }]
                });
                navigator.mediaSession.playbackState = 'playing';
            }
        }

        function updateCycleStatus() {
            const target = parseInt(document.getElementById('cycles-target').value) || 4;
            const mode = isWorkSession ? "–†–ê–ë–û–¢–ê" : "–û–¢–î–´–•";
            document.getElementById('cycle-status').innerText = `${mode} ‚Ä¢ –¶–ò–ö–õ ${currentCycle} / ${target}`;
        }

        function startTimer() {
            if (timerInterval) return;
            timerEndTime = Date.now() + timeLeft * 1000;

            // ACTIVATE THE VOID MODE
            document.body.classList.add('void-mode');

            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((timerEndTime - now) / 1000);

                if (diff >= 0) {
                    timeLeft = diff;

                    // Force background audio if needed
                    const mainAudio = document.getElementById('audio');
                    const silence = document.getElementById('silence-loop');
                    if (mainAudio.paused && silence.paused) {
                        silence.play().catch(() => { });
                    }

                    if (isWorkSession && timeLeft === 25 && vecnaEnabled) {
                        const vecna = document.getElementById('vecna-sfx');
                        vecna.currentTime = 0;
                        vecna.volume = 0.8;
                        vecna.play().catch(() => { });
                    }
                    updateDisplay();
                }

                if (diff <= 0) {
                    timeLeft = 0;
                    updateDisplay();
                    handleTimerComplete();
                }
            }, 500);
        }

        function stopTicking() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            const btn = document.getElementById('t-start-btn');
            btn.innerText = "–°–¢–ê–†–¢";
            btn.classList.remove('active');

            // DEACTIVATE THE VOID MODE
            document.body.classList.remove('void-mode');

            const vecna = document.getElementById('vecna-sfx');
            vecna.pause(); vecna.currentTime = 0;
        }

        function fullReset() {
            saveTimerState();
            stopTicking();
            isWorkSession = true;
            currentCycle = 1;
            resetTime();

            // DEACTIVATE THE VOID MODE (already called in stopTicking, but ensure it's off)
            document.body.classList.remove('void-mode');
        }

        function handleTimerComplete() {
            stopTicking();
            triggerLightning();

            const targetCycles = parseInt(document.getElementById('cycles-target').value) || 4;
            let nextModeMsg = "";

            if (isWorkSession) {
                if (currentCycle >= targetCycles) {
                    nextModeMsg = "–°–î–ï–õ–ê–¢–¨ –ë–û–õ–¨–®–û–ô –ü–ï–†–ï–†–´–í";
                } else {
                    nextModeMsg = "–°–î–ï–õ–ê–¢–¨ –ü–ï–†–ï–†–´–í";
                }
                isWorkSession = false;
            } else {
                nextModeMsg = "–ü–†–û–î–û–õ–ñ–ò–¢–¨ –†–ê–ë–û–¢–£";
                isWorkSession = true;
                if (currentCycle >= targetCycles) {
                    currentCycle = 1;
                } else {
                    currentCycle++;
                }
            }

            resetTime();

            playGong();
            document.getElementById('alarm-message').innerText = nextModeMsg;
            document.getElementById('alarm-modal').classList.add('open');
        }

        function playGong() {
            const gong = document.getElementById('gong-sfx');
            gong.currentTime = 0;
            gong.play().catch(() => { });
        }

        function stopGongSound() {
            const gong = document.getElementById('gong-sfx');
            gong.pause();
            gong.currentTime = 0;
        }

        function endCycleFromModal() {
            stopGongSound();
            document.getElementById('alarm-modal').classList.remove('open');
            fullReset();
        }

        function continueCycle() {
            stopGongSound();
            document.getElementById('alarm-modal').classList.remove('open');
            toggleTimer();
        }

        function toggleTimer() {
            const btn = document.getElementById('t-start-btn');
            if (timerInterval) {
                stopTicking();
            } else {
                btn.innerText = "–ü–ê–£–ó–ê";
                btn.classList.add('active');

                const vecna = document.getElementById('vecna-sfx');
                vecna.muted = true;
                vecna.play().then(() => {
                    vecna.pause();
                    vecna.currentTime = 0;
                    vecna.muted = false;
                }).catch(() => { });

                const gong = document.getElementById('gong-sfx');
                gong.muted = true;
                gong.play().then(() => {
                    gong.pause();
                    gong.currentTime = 0;
                    gong.muted = false;
                }).catch(() => { });

                ensureAudioContext(); // Enable background mode
                startTimer();
            }
        }

        function stopTimer() {
            const silence = document.getElementById('silence-loop');
            silence.pause();
            fullReset();
        }

        function resetTime() {
            const work = parseInt(document.getElementById('work-time').value) || 25;
            const brk = parseInt(document.getElementById('break-time').value) || 5;
            const longBrk = parseInt(document.getElementById('long-break-time').value) || 15;
            const targetCycles = parseInt(document.getElementById('cycles-target').value) || 4;

            if (isWorkSession) {
                timeLeft = work * 60;
            } else {
                if (currentCycle >= targetCycles) {
                    timeLeft = longBrk * 60;
                } else {
                    timeLeft = brk * 60;
                }
            }

            updateDisplay();
            updateCycleStatus();
        }

        function updateSettings() {
            if (!timerInterval) {
                resetTime();
            } else {
                updateCycleStatus();
            }
        }

        function selectNewColor(color) {
            newSelectedColor = color;
            document.querySelectorAll('.new-color-opt').forEach(el => el.classList.remove('selected'));
            document.getElementById('new-col-' + color).classList.add('selected');
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').classList.add('open');
            const val = Math.round(currentFontSize * 16);
            document.getElementById('font-size-slider').value = val;
            document.getElementById('font-family-select').value = currentFontFamily;
            updatePreview();
        }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.remove('open'); }
        function updateFontSize(pxVal) {
            const remVal = pxVal / 16;
            currentFontSize = remVal;
            document.documentElement.style.setProperty('--task-font-size', remVal + 'rem');
            localStorage.setItem('stas_font_size', remVal);
            updatePreview();
        }
        function updateFontFamily(val) {
            currentFontFamily = val;
            document.documentElement.style.setProperty('--task-font-family', val);
            localStorage.setItem('stas_font_family', val);
            updatePreview();
        }
        function updatePreview() {
            const p = document.getElementById('font-preview');
            p.style.fontSize = currentFontSize + 'rem';
            p.style.fontFamily = currentFontFamily;
        }

        function openEditModal(id) {
            const t = tasks.find(x => String(x.id) === String(id));
            if (!t) return;
            currentEditId = id;
            document.getElementById('edit-task-input').value = t.txt;
            const col = t.color || 'red';
            selectColor(col);
            document.getElementById('edit-modal').classList.add('open');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('open'); currentEditId = null; }
        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-opt').forEach(el => el.classList.remove('selected'));
            document.getElementById('col-' + color).classList.add('selected');
        }
        function saveEditTask() {
            if (!currentEditId) return;
            const newTxt = document.getElementById('edit-task-input').value.trim();
            if (newTxt) {
                const t = tasks.find(x => String(x.id) === String(currentEditId));
                if (t) {
                    t.txt = newTxt;
                    t.color = selectedColor;
                    save();
                    render();

                    // Sync to cloud if logged in
                    if (currentUser) {
                        updateTaskInCloud(currentEditId, {
                            title: newTxt,
                            color: selectedColor
                        });
                    }
                }
            }
            closeEditModal();
        }

        function del(id) {
            const t = tasks.find(x => String(x.id) === String(id));
            if (!t) return;

            if (!t.done) {
                // Active task -> Show Warning
                taskToDeleteId = id;
                document.getElementById('delete-modal').classList.add('open');
            } else {
                // Completed task -> Delete immediately
                executeDelete(id);
            }
        }

        function confirmDelete() {
            if (taskToDeleteId) {
                executeDelete(taskToDeleteId);
                closeDeleteModal();
            }
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('open');
            taskToDeleteId = null;
        }

        async function executeDelete(id) {
            // Local delete
            tasks = tasks.filter(x => String(x.id) !== String(id));
            playSfx('del');
            save();
            render();

            // Sync to cloud if logged in
            if (currentUser) {
                console.log('Syncing delete to cloud for task:', id);
                await deleteTaskFromCloud(id);
            }
        }

        // === RADIO PANEL TOGGLE ===
        function toggleRadioPanel() {
            const header = document.querySelector('.radio-header');
            const content = document.querySelector('.radio-content');

            header.classList.toggle('collapsed');
            content.classList.toggle('hidden');
        }

        // === BURN ARCHIVE MODAL ===
        function openBurnModal() {
            // Check if there are any completed tasks
            const completedTasks = tasks.filter(t => t.done);
            if (completedTasks.length === 0) {
                // No completed tasks to burn
                return;
            }
            document.getElementById('burn-modal').classList.add('open');
        }

        function closeBurnModal() {
            document.getElementById('burn-modal').classList.remove('open');
        }

        async function confirmBurnArchive() {
            closeBurnModal();
            await burnArchive();
        }

        async function burnArchive() {
            // Get all completed tasks before filtering
            const completedTasks = tasks.filter(t => t.done);

            if (completedTasks.length === 0) {
                return;
            }

            // Filter out completed tasks (keep only non-completed)
            tasks = tasks.filter(t => !t.done);

            // Play effects
            playSfx('del');
            triggerLightning();

            // Save to localStorage
            save();

            // Re-render
            render();

            // Sync to cloud if logged in
            if (currentUser && supabaseClient) {
                console.log('Syncing burn archive to cloud:', completedTasks.length, 'tasks');

                // Delete each completed task from cloud
                for (const task of completedTasks) {
                    await deleteTaskFromCloud(task.id);
                }
            }
        }

        function initSpores() {
            const container = document.getElementById('spores-container');
            for (let i = 0; i < 50; i++) {
                const spore = document.createElement('div');
                spore.classList.add('spore');
                spore.style.left = Math.random() * 100 + '%';
                const size = Math.random() * 4 + 2;
                spore.style.width = size + 'px'; spore.style.height = size + 'px';
                const dur = Math.random() * 5 + 5;
                spore.style.animation = `fall ${dur}s linear infinite ${Math.random() * 5}s, sway ${Math.random() * 2 + 2}s ease-in-out infinite alternate`;
                container.appendChild(spore);
            }
        }

        let thunderTimer;
        function startThunderLoop() {
            thunderTimer = setTimeout(() => {
                triggerLightning();
                startThunderLoop();
            }, Math.random() * 5000 + 5000);
        }
        function stopThunderLoop() { clearTimeout(thunderTimer); }
        function triggerLightning() {
            const light = document.getElementById('lightning');
            light.classList.remove('flash-now');
            void light.offsetWidth;
            light.classList.add('flash-now');
        }

        function initApp() {
            initSelects();
            initSpores();
            render();
            initDrag();
            resetTime();
            const au = document.getElementById('audio');
            au.src = songs[curCh];
            au.volume = 0.5;

            // Initialize Supabase client first
            initSupabase();

            // Then initialize auth (after a small delay to ensure Supabase is ready)
            setTimeout(() => {
                if (supabaseClient) {
                    initAuth();
                }
            }, 100);

            // Setup Media Session Actions (Required for iOS Control Center to stay active)
            if ('mediaSession' in navigator) {
                const actions = [['play', toggleTimer], ['pause', toggleTimer], ['stop', stopTimer], ['previoustrack', fullReset], ['nexttrack', forceNextStep]];
                for (const [action, handler] of actions) {
                    try { navigator.mediaSession.setActionHandler(action, handler); } catch (error) { }
                }
            }

            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ENTER –¥–ª—è –∑–∞–º–µ—Ç–æ–∫
            document.getElementById('notes-editor').addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);

                    let currentItem = range.commonAncestorContainer;
                    if (currentItem.nodeType === 3) currentItem = currentItem.parentNode;

                    const checklistItem = currentItem.closest('.checklist-item');

                    if (checklistItem) {
                        // Check if current item is empty to exit list
                        const span = checklistItem.querySelector('span');
                        const text = span ? span.textContent.replace(/\u00A0/g, '').trim() : '';

                        if (text === '') {
                            e.preventDefault();
                            // Turn into regular div
                            const regularLine = document.createElement('div');
                            regularLine.innerHTML = '<br>';
                            checklistItem.replaceWith(regularLine);

                            const newRange = document.createRange();
                            newRange.setStart(regularLine, 0);
                            newRange.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                            return;
                        }

                        e.preventDefault();

                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç
                        const newItem = document.createElement('div');
                        newItem.className = 'checklist-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';

                        const newSpan = document.createElement('span');
                        newSpan.textContent = '\u00A0';

                        newItem.appendChild(checkbox);
                        newItem.appendChild(newSpan);

                        checklistItem.after(newItem);

                        // –§–æ–∫—É—Å –Ω–∞ –Ω–æ–≤—ã–π —Å–ø–∞–Ω
                        const newRange = document.createRange();
                        if (newSpan.firstChild) {
                            newRange.setStart(newSpan.firstChild, 0);
                        } else {
                            newRange.setStart(newSpan, 0);
                        }

                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                }
            });

            document.getElementById('notes-editor').addEventListener('change', function (e) {
                if (e.target.type === 'checkbox') {
                    if (e.target.checked) {
                        e.target.setAttribute('checked', 'true');
                    } else {
                        e.target.removeAttribute('checked');
                    }
                }
            });
        }

        function addTask() {
            const inp = document.getElementById('task-input');
            const val = inp.value.trim();
            if (!val) return;

            const newTask = {
                id: Date.now(),
                txt: val,
                done: false,
                color: newSelectedColor,
                order_index: tasks.length
            };
            tasks.push(newTask);
            inp.value = '';
            playSfx('click');
            save();
            render();

            // Sync to cloud if logged in
            if (currentUser) {
                uploadTaskToCloud(newTask);
            }
        }

        async function uploadTaskToCloud(task) {
            if (!currentUser || !supabaseClient) return;
            showSyncIndicator();

            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .insert({
                        user_id: currentUser.id,
                        title: task.txt,
                        is_completed: task.done,
                        color: task.color || 'red',
                        order_index: task.order_index || 0
                    })
                    .select()
                    .single();

                if (error) throw error;

                // CRITICAL BUGFIX: Update local task ID AND DOM data-id attribute
                // This fixes the "ghosting" bug when dragging newly created tasks
                const oldId = task.id;
                const localTask = tasks.find(t => t.id === oldId);
                if (localTask && data) {
                    localTask.id = data.id;
                    localTask.order_index = data.order_index;

                    // Update DOM element data-id WITHOUT full re-render
                    // This allows SortableJS to continue tracking the correct ID
                    const domElement = document.querySelector(`li[data-id="${oldId}"]`);
                    if (domElement) {
                        domElement.dataset.id = data.id;

                        // Update all onclick handlers to use new ID
                        const newIdStr = String(data.id);
                        domElement.querySelector('.checkbox').setAttribute('onclick', `toggle('${newIdStr}')`);
                        domElement.querySelector('.task-text').setAttribute('onclick', `toggle('${newIdStr}')`);
                        domElement.querySelector('.btn-edit').setAttribute('onclick', `openEditModal('${newIdStr}')`);
                        domElement.querySelector('.btn-del').setAttribute('onclick', `del('${newIdStr}')`);
                    }

                    save();
                }
            } catch (error) {
                console.error('Upload Error:', error);
            } finally {
                hideSyncIndicator();
            }
        }

        function toggle(id) {
            const t = tasks.find(x => String(x.id) === String(id));
            if (t) {
                t.done = !t.done;
                playSfx('click');
                save();
                render();

                // Sync to cloud if logged in
                if (currentUser) {
                    updateTaskInCloud(id, { is_completed: t.done });
                }
            }
        }

        function save() {
            try { localStorage.setItem(DB_KEY, JSON.stringify(tasks)); } catch (e) { }
        }

        // ========== SECURITY: XSS PROTECTION ==========
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function render() {
            const act = document.getElementById('active-list');
            const com = document.getElementById('completed-list');

            // PERFORMANCE: Use DocumentFragment instead of innerHTML in loop
            const actFragment = document.createDocumentFragment();
            const comFragment = document.createDocumentFragment();

            tasks.forEach(t => {
                const li = document.createElement('li');
                const colorClass = t.color ? 'border-' + t.color : 'border-red';
                li.className = `task-item ${t.done ? 'completed' : ''} ${colorClass}`;
                li.dataset.id = t.id;

                const taskIdStr = String(t.id);
                li.innerHTML = `
                    <div class="checkbox" onclick="toggle('${taskIdStr}')"></div>
                    <span class="task-text" onclick="toggle('${taskIdStr}')">${escapeHtml(t.txt)}</span>
                    <button class="btn-action btn-edit" onclick="openEditModal('${taskIdStr}')">‚úé</button>
                    <button class="btn-action btn-del" onclick="del('${taskIdStr}')">√ó</button>
                `;

                if (t.done) {
                    comFragment.appendChild(li);
                } else {
                    actFragment.appendChild(li);
                }
            });

            // Single DOM write per list (MUCH faster)
            act.innerHTML = '';
            com.innerHTML = '';
            act.appendChild(actFragment);
            com.appendChild(comFragment);
        }

        function setCh(idx) {
            curCh = idx;
            const au = document.getElementById('audio');

            const btn = document.getElementById('play-btn');
            const isPlaying = btn.classList.contains('playing');

            au.pause();

            au.src = songs[idx];

            if (isPlaying) {
                const playPromise = au.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Playback failed:", error);
                    });
                }
            }

            document.querySelectorAll('.ch-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            playSfx('click');
        }

        function toggleAudio() {
            const au = document.getElementById('audio');
            const btn = document.getElementById('play-btn');

            if (btn.classList.contains('playing')) {
                au.pause();
                btn.innerText = "–ù–ê–ß–ê–¢–¨ –≠–§–ò–†";
                btn.classList.remove('playing');
                document.body.classList.remove('music-active');
                stopThunderLoop();
            } else {
                const playPromise = au.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        btn.innerText = "–û–°–¢–ê–ù–û–í–ò–¢–¨ –≠–§–ò–†";
                        btn.classList.add('playing');
                        document.body.classList.add('music-active');
                        startThunderLoop();
                        triggerLightning();
                    })
                        .catch(error => {
                            console.error(error);
                            showToast("–û–®–ò–ë–ö–ê –ê–£–î–ò–û –ü–û–¢–û–ö–ê");
                            btn.innerText = "–ù–ê–ß–ê–¢–¨ –≠–§–ò–†";
                            btn.classList.remove('playing');
                            document.body.classList.remove('music-active');
                        });
                }
            }
        }

        // Debounce timer for drag-and-drop cloud sync
        let dragDebounceTimer = null;

        function initDrag() {
            if (typeof Sortable !== 'undefined') {
                const opts = {
                    animation: 150,
                    delay: 200,
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    scroll: document.getElementById('app-ui'), // SCROLL CONTAINER
                    scrollSensitivity: 150,
                    scrollSpeed: 20,
                    bubbleScroll: true,
                    forceFallback: true, // Fix for iOS scrolling
                    fallbackClass: 'sortable-fallback',
                    fallbackOnBody: true,
                    touchStartThreshold: 5,
                    onEnd: () => {
                        const newOrder = [];
                        document.querySelectorAll('.task-item').forEach(el => {
                            const found = tasks.find(t => t.id == el.dataset.id);
                            if (found) newOrder.push(found);
                        });
                        tasks = newOrder;

                        // Update order_index for all tasks
                        tasks.forEach((task, index) => {
                            task.order_index = index;
                        });

                        // INSTANT local save
                        save();

                        // DEBOUNCED cloud sync (PERFORMANCE: Prevents request waterfall)
                        if (currentUser) {
                            clearTimeout(dragDebounceTimer);
                            dragDebounceTimer = setTimeout(() => {
                                updateTaskOrderInCloud();
                            }, 2000); // Wait 2s after user stops dragging
                        }
                    }
                };
                Sortable.create(document.getElementById('active-list'), opts);
                Sortable.create(document.getElementById('completed-list'), opts);
            }
        }

        window.onload = initApp;

        // ========== SUPABASE AUTH FUNCTIONS ==========
        async function initAuth() {
            if (!supabaseClient) return;
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await handleLogin();
                }
                updateAuthUI();
            } catch (error) {
                console.error('Init Auth Error:', error);
                updateAuthUI();
            }
        }

        async function sendOTP() {
            if (!supabaseClient) {
                showToast('–°–ò–°–¢–ï–ú–ê –ù–ï –ì–û–¢–û–í–ê');
                return;
            }
            const email = document.getElementById('auth-email').value.trim();
            if (!email) {
                showToast('–í–í–ï–î–ò–¢–ï EMAIL');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        shouldCreateUser: true
                    }
                });

                if (error) throw error;

                pendingEmail = email;
                document.getElementById('sent-email').innerText = email;
                updateAuthUI('awaiting-code');
                showToast('–ö–û–î –û–¢–ü–†–ê–í–õ–ï–ù –ù–ê EMAIL');
            } catch (error) {
                console.error('OTP Error:', error);
                showToast('–û–®–ò–ë–ö–ê –û–¢–ü–†–ê–í–ö–ò: ' + error.message);
            }
        }

        async function verifyOTP() {
            if (!supabaseClient) {
                showToast('–°–ò–°–¢–ï–ú–ê –ù–ï –ì–û–¢–û–í–ê');
                return;
            }
            const code = document.getElementById('auth-code').value.trim();
            if (!code || code.length !== 6) {
                showToast('–í–í–ï–î–ò–¢–ï 6-–ó–ù–ê–ß–ù–´–ô –ö–û–î');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.verifyOtp({
                    email: pendingEmail,
                    token: code,
                    type: 'email'
                });

                if (error) throw error;

                currentUser = data.user;
                await handleLogin();
                showToast('–°–í–Ø–ó–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–ê');
            } catch (error) {
                console.error('Verify Error:', error);
                showToast('–ù–ï–í–ï–†–ù–´–ô –ö–û–î: ' + error.message);
            }
        }

        async function logout() {
            if (!supabaseClient) return;
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                pendingEmail = '';

                // Unsubscribe from realtime
                if (realtimeChannel) {
                    await supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }

                updateAuthUI();
                showToast('–°–í–Ø–ó–¨ –†–ê–ó–û–†–í–ê–ù–ê');
            } catch (error) {
                console.error('Logout Error:', error);
                showToast('–û–®–ò–ë–ö–ê –í–´–•–û–î–ê');
            }
        }

        function updateAuthUI(state) {
            const statusEl = document.getElementById('auth-status');
            const loginForm = document.getElementById('auth-login-form');
            const codeForm = document.getElementById('auth-code-form');
            const loggedIn = document.getElementById('auth-logged-in');
            const userEmail = document.getElementById('auth-user-email');

            // Hide all forms first
            loginForm.style.display = 'none';
            codeForm.style.display = 'none';
            loggedIn.style.display = 'none';

            if (currentUser) {
                // Logged in state
                statusEl.innerHTML = '<span class="status-online">üü¢ –í –≠–§–ò–†–ï (ON AIR)</span>';
                userEmail.innerText = currentUser.email;
                loggedIn.style.display = 'block';

                // Update Main Screen Indicator
                document.getElementById('main-air-dot').classList.add('on');
                document.getElementById('main-air-text').innerText = 'ON AIR';
                document.getElementById('main-air-text').style.color = 'var(--color-green)';
            } else if (state === 'awaiting-code') {
                // Awaiting code state
                statusEl.innerHTML = '<span class="status-offline">üî¥ –û–ñ–ò–î–ê–ù–ò–ï –®–ò–§–†–û–í–ö–ò</span>';
                codeForm.style.display = 'block';

                // Update Main Screen Indicator (Keep as Off/Waiting)
                document.getElementById('main-air-dot').classList.remove('on');
                document.getElementById('main-air-text').innerText = 'OFF AIR';
                document.getElementById('main-air-text').style.color = '#555';
            } else {
                // Logged out state - SHOW LOGIN FORM
                statusEl.innerHTML = '<span class="status-offline">üî¥ –í–ù–ï –≠–§–ò–†–ê (OFF AIR)</span>';
                loginForm.style.display = 'block';

                // Update Main Screen Indicator
                document.getElementById('main-air-dot').classList.remove('on');
                document.getElementById('main-air-text').innerText = 'OFF AIR';
                document.getElementById('main-air-text').style.color = '#555';
            }
        }

        async function handleLogin() {
            if (!currentUser) return;

            // Trigger synchronization
            await syncTasksOnLogin();
            await syncNotesOnLogin();

            // Subscribe to realtime updates
            subscribeToTasks();
            subscribeToNotes();

            updateAuthUI();
        }

        // ========== TASK SYNCHRONIZATION ==========
        async function syncTasksOnLogin() {
            if (!currentUser || !supabaseClient) return;
            showSyncIndicator();

            try {
                // Get local tasks
                const localTasks = tasks;

                // Get cloud tasks
                const { data: cloudTasks, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('order_index', { ascending: true });

                if (error) throw error;

                if (!cloudTasks || cloudTasks.length === 0) {
                    // Cloud is empty - BULK INSERT all local tasks (PERFORMANCE)
                    if (tasks.length > 0) {
                        tasks.forEach((t, i) => t.order_index = i);

                        const tasksToUpload = tasks.map(task => ({
                            user_id: currentUser.id,
                            title: task.txt,
                            is_completed: task.done,
                            color: task.color || 'red',
                            order_index: task.order_index || 0
                        }));

                        const { error: bulkError } = await supabaseClient
                            .from('tasks')
                            .insert(tasksToUpload);

                        if (bulkError) throw bulkError;
                        showToast('–ó–ê–î–ê–ß–ò –ó–ê–ì–†–£–ñ–ï–ù–´ –í –û–ë–õ–ê–ö–û');
                    }
                } else {
                    // Merge: Cloud priority + unique local
                    // Filter out cloud tasks that are soft-deleted
                    const activeCloudTasks = cloudTasks.filter(ct => !ct.is_deleted);

                    // Convert cloud tasks to our format
                    const convertedCloudTasks = activeCloudTasks.map(ct => ({
                        id: ct.id,
                        txt: ct.title,
                        done: ct.is_completed,
                        color: ct.color || 'red',
                        order_index: ct.order_index || 0
                    }));

                    // Find unique local tasks not in cloud and UPLOAD them
                    // Also check if local task exists in cloud but is marked deleted (ZOMBIE CHECK)
                    for (const localTask of localTasks) {
                        const cloudMatch = cloudTasks.find(ct =>
                            ct.title === localTask.txt && ct.is_completed === localTask.done
                        );

                        if (!cloudMatch) {
                            // Unique local task - Safe to upload
                            const { data: newTask, error: uploadError } = await supabaseClient
                                .from('tasks')
                                .insert({
                                    user_id: currentUser.id,
                                    title: localTask.txt,
                                    is_completed: localTask.done,
                                    color: localTask.color || 'red',
                                    order_index: localTask.order_index || convertedCloudTasks.length,
                                    is_deleted: false
                                })
                                .select()
                                .single();

                            if (!uploadError && newTask) {
                                convertedCloudTasks.push({
                                    id: newTask.id,
                                    txt: newTask.title,
                                    done: newTask.is_completed,
                                    color: newTask.color || 'red',
                                    order_index: newTask.order_index || 0
                                });
                            }
                        }
                        // If cloudMatch exists and is_deleted is true, we simply ignore the local task 
                        // (effectively deleting it from local state by not adding it to convertedCloudTasks)
                    }

                    // Update local state with merged (and filtered) cloud tasks
                    tasks = convertedCloudTasks;

                    // Final sort just in case
                    tasks.sort((a, b) => (a.order_index || 0) - (b.order_index || 0));

                    save();
                    render();
                    showToast('–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê');
                }
            } catch (error) {
                console.error('Sync Error:', error);
                showToast('–û–®–ò–ë–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò');
            } finally {
                hideSyncIndicator();
            }
        }

        async function uploadTask(task) {
            if (!currentUser || !supabaseClient) return;

            try {
                const { error } = await supabaseClient
                    .from('tasks')
                    .insert({
                        user_id: currentUser.id,
                        title: task.txt,
                        is_completed: task.done,
                        color: task.color || 'red',
                        order_index: task.order_index || 0
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Upload Task Error:', error);
            }
        }

        async function updateTaskOrderInCloud() {
            if (!currentUser || !supabaseClient) return;
            showSyncIndicator();

            try {
                // Perform a bulk upsert to update order_index for all tasks
                const updates = tasks.map(t => ({
                    id: t.id,
                    user_id: currentUser.id,
                    title: t.txt,
                    is_completed: t.done,
                    color: t.color || 'red',
                    order_index: t.order_index
                }));

                // ADDED TIMEOUT: If network is slow, don't hang forever
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('TIMEOUT')), 5000)
                );

                const updatePromise = supabaseClient
                    .from('tasks')
                    .upsert(updates);

                const { error } = await Promise.race([updatePromise, timeoutPromise]);

                if (error) throw error;
            } catch (error) {
                console.error('Update Order Error:', error);
                if (error.message === 'TIMEOUT') {
                    showToast('–°–ï–¢–¨ –¢–û–†–ú–û–ó–ò–¢: –ü–û–†–Ø–î–û–ö –ù–ï –°–û–•–†–ê–ù–ï–ù');
                }
            } finally {
                hideSyncIndicator();
            }
        }

        async function updateTaskInCloud(taskId, updates) {
            if (!currentUser || !supabaseClient) return;

            try {
                // ADDED TIMEOUT
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('TIMEOUT')), 5000)
                );

                const updatePromise = supabaseClient
                    .from('tasks')
                    .update(updates)
                    .eq('id', taskId)
                    .eq('user_id', currentUser.id);

                const { error } = await Promise.race([updatePromise, timeoutPromise]);

                if (error) throw error;
            } catch (error) {
                console.error('Update Task Error:', error);
                if (error.message === 'TIMEOUT') {
                    showToast('–°–õ–ê–ë–ê–Ø –°–ï–¢–¨: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ù–ï –û–¢–ü–†–ê–í–õ–ï–ù–û');
                }
            }
        }

        async function deleteTaskFromCloud(taskId) {
            if (!currentUser || !supabaseClient) return;

            try {
                // Soft Delete: Update is_deleted = true
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .update({ is_deleted: true })
                    .eq('id', taskId)
                    .eq('user_id', currentUser.id)
                    .select();

                if (error) throw error;

                if (data && data.length > 0) {
                    console.log('Soft deleted task in cloud:', taskId);
                } else {
                    console.warn('Task not found or not owned by user for soft delete:', taskId);
                }
            } catch (error) {
                console.error('Delete Task Error:', error);
                showToast('–û–®–ò–ë–ö–ê –£–î–ê–õ–ï–ù–ò–Ø: ' + error.message);
            }
        }

        // ========== NOTES SYNCHRONIZATION ==========
        async function syncNotesOnLogin() {
            if (!currentUser || !supabaseClient) return;
            showSyncIndicator();

            try {
                // Get cloud notes
                const { data: cloudNote, error } = await supabaseClient
                    .from('notes')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
                    throw error;
                }

                const localNotes = localStorage.getItem(NOTES_KEY) || '';

                if (!cloudNote && localNotes) {
                    // Cloud empty, upload local
                    await uploadNotesToCloud(localNotes);
                } else if (cloudNote) {
                    // Cloud has data, use it as truth
                    localStorage.setItem(NOTES_KEY, cloudNote.content);
                }
            } catch (error) {
                console.error('Notes Sync Error:', error);
            } finally {
                hideSyncIndicator();
            }
        }

        async function uploadNotesToCloud(content) {
            if (!currentUser || !supabaseClient) return;
            showSyncIndicator();

            try {
                const { error } = await supabaseClient
                    .from('notes')
                    .upsert({
                        user_id: currentUser.id,
                        content: content,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Upload Notes Error:', error);
                showToast('–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ó–ê–ú–ï–¢–û–ö');
            } finally {
                hideSyncIndicator();
            }
        }

        // ========== REALTIME SUBSCRIPTIONS ==========
        function subscribeToTasks() {
            if (!currentUser || realtimeChannel || !supabaseClient) {
                console.log('subscribeToTasks skipped:', { currentUser: !!currentUser, realtimeChannel: !!realtimeChannel, supabaseClient: !!supabaseClient });
                return;
            }

            console.log('Creating Realtime subscription for user:', currentUser.id);
            realtimeChannel = supabaseClient
                .channel('tasks-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'tasks',
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        console.log('Realtime event received:', payload);
                        handleRealtimeEvent(payload);
                    }
                )
                .subscribe((status) => {
                    console.log('Realtime subscription status:', status);
                });
        }

        function subscribeToNotes() {
            if (!currentUser || notesRealtimeChannel || !supabaseClient) {
                console.log('subscribeToNotes skipped:', { currentUser: !!currentUser, notesRealtimeChannel: !!notesRealtimeChannel, supabaseClient: !!supabaseClient });
                return;
            }

            console.log('Creating Realtime subscription for notes, user:', currentUser.id);
            notesRealtimeChannel = supabaseClient
                .channel('notes-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'notes',
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    (payload) => {
                        console.log('Notes Realtime event received:', payload);
                        handleNotesRealtimeEvent(payload);
                    }
                )
                .subscribe((status) => {
                    console.log('Notes Realtime subscription status:', status);
                });
        }

        function handleNotesRealtimeEvent(payload) {
            console.log('handleNotesRealtimeEvent called with:', payload);
            const { eventType, new: newRecord } = payload;
            console.log('Notes event type:', eventType, 'New:', newRecord);

            if (eventType === 'INSERT' || eventType === 'UPDATE') {
                // Update local notes from cloud
                if (newRecord && newRecord.content !== undefined) {
                    console.log('Updating notes from cloud, content length:', newRecord.content.length);
                    const currentContent = localStorage.getItem(NOTES_KEY) || '';

                    console.log('Current content length:', currentContent.length);
                    console.log('New content length:', newRecord.content.length);
                    console.log('Contents equal?', currentContent === newRecord.content);

                    // Always update localStorage
                    localStorage.setItem(NOTES_KEY, newRecord.content);

                    // ALWAYS update editor if notes modal is open
                    const notesModal = document.getElementById('notes-modal');
                    const editor = document.getElementById('notes-editor');

                    if (notesModal && editor) {
                        const isOpen = notesModal.classList.contains('open');
                        console.log('Notes modal open?', isOpen);

                        if (isOpen) {
                            console.log('Updating editor innerHTML');
                            editor.innerHTML = newRecord.content;
                            showToast('–ó–ê–ú–ï–¢–ö–ò –û–ë–ù–û–í–õ–ï–ù–´ –ò–ó –û–ë–õ–ê–ö–ê');
                        }
                    } else {
                        console.log('Editor or modal not found');
                    }
                }
            }
        }

        function handleRealtimeEvent(payload) {
            console.log('handleRealtimeEvent called with:', payload);
            const { eventType, new: newRecord, old: oldRecord } = payload;
            console.log('Event type:', eventType, 'New:', newRecord, 'Old:', oldRecord);

            if (eventType === 'INSERT') {
                // Only insert if not marked as deleted
                if (!newRecord.is_deleted) {
                    const newTask = {
                        id: newRecord.id,
                        txt: newRecord.title,
                        done: newRecord.is_completed,
                        color: newRecord.color || 'red',
                        order_index: newRecord.order_index || 0
                    };

                    // FIXED: Use String() comparison for consistency with UPDATE/DELETE
                    if (!tasks.find(t => String(t.id) === String(newTask.id))) {
                        console.log('Adding new task from cloud:', newTask);
                        tasks.push(newTask);
                        tasks.sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
                        save();
                        render();
                        showToast('–ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê –ò–ó –û–ë–õ–ê–ö–ê');
                    } else {
                        console.log('Task already exists, skipping:', newTask.id);
                    }
                } else {
                    console.log('Skipping deleted task:', newRecord.id);
                }
            } else if (eventType === 'UPDATE') {
                console.log('Processing UPDATE event');
                if (newRecord.is_deleted) {
                    // Treat soft delete as DELETE
                    const index = tasks.findIndex(t => String(t.id) === String(newRecord.id));
                    if (index !== -1) {
                        console.log('Removing soft-deleted task:', newRecord.id);
                        tasks.splice(index, 1);
                        save();
                        render();
                        showToast('–ó–ê–î–ê–ß–ê –£–î–ê–õ–ï–ù–ê –í –û–ë–õ–ê–ö–ï');
                    } else {
                        console.log('Soft-deleted task not found locally:', newRecord.id);
                    }
                } else {
                    // Normal UPDATE (if not deleted)
                    const task = tasks.find(t => String(t.id) === String(newRecord.id));
                    if (task) {
                        console.log('Updating task:', newRecord.id);
                        task.txt = newRecord.title;
                        task.done = newRecord.is_completed;
                        task.color = newRecord.color || 'red';
                        task.order_index = newRecord.order_index || 0;

                        tasks.sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
                        save();
                        render();
                    } else {
                        console.log('Task not found for update:', newRecord.id);
                    }
                }
            } else if (eventType === 'DELETE') {
                console.log('Processing DELETE event');
                // Keep handling hard deletes just in case
                const index = tasks.findIndex(t => String(t.id) === String(oldRecord.id));
                if (index !== -1) {
                    console.log('Removing hard-deleted task:', oldRecord.id);
                    tasks.splice(index, 1);
                    save();
                    render();
                    showToast('–ó–ê–î–ê–ß–ê –£–î–ê–õ–ï–ù–ê –í –û–ë–õ–ê–ö–ï');
                } else {
                    console.log('Hard-deleted task not found locally:', oldRecord.id);
                }
            }
        }

        function showSyncIndicator() {
            const indicator = document.getElementById('sync-indicator');
            if (indicator) {
                indicator.classList.add('visible');
            }
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('sync-indicator');
            if (indicator) {
                indicator.classList.remove('visible');
            }
        }

        // --- –ó–ê–ú–ï–¢–ö–ò (NOTES) –§–£–ù–ö–¶–ò–û–ù–ê–õ ---
        const NOTES_KEY = 'STRANGER_THINGS_NOTES';
        let originalNotesContent = '';

        function openNotes() {
            const modal = document.getElementById('notes-modal');
            const editor = document.getElementById('notes-editor');
            const savedNotes = localStorage.getItem(NOTES_KEY) || '';

            editor.innerHTML = savedNotes;
            originalNotesContent = savedNotes;

            modal.classList.add('open');
        }

        function saveNotes() {
            const editor = document.getElementById('notes-editor');
            const content = editor.innerHTML;
            localStorage.setItem(NOTES_KEY, content);

            // Sync to cloud if logged in
            if (currentUser) {
                uploadNotesToCloud(content);
            }

            const modal = document.getElementById('notes-modal');
            modal.classList.remove('open');
        }

        function checkNotesClose() {
            const editor = document.getElementById('notes-editor');
            const currentContent = editor.innerHTML;

            if (currentContent !== originalNotesContent) {
                // –í–º–µ—Å—Ç–æ native confirm –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –º–æ–¥–∞–ª–∫—É
                document.getElementById('unsaved-modal').classList.add('open');
            } else {
                closeNotesForce();
            }
        }

        function closeUnsavedModal() {
            document.getElementById('unsaved-modal').classList.remove('open');
        }

        function confirmCloseNotes() {
            closeUnsavedModal();
            closeNotesForce();
        }

        function closeNotesForce() {
            document.getElementById('notes-modal').classList.remove('open');
        }

        function formatDoc(cmd, value = null) {
            if (value) {
                document.execCommand(cmd, false, value);
            } else {
                document.execCommand(cmd);
            }
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            document.getElementById('notes-editor').focus();
        }

        function insertChecklist() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const text = selection.toString();

            // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ —Å—Ç—Ä–æ–∫–∞–º
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

            if (lines.length === 0) {
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —á–µ–∫–±–æ–∫—Å
                const div = createChecklistItem('');
                range.deleteContents();
                range.insertNode(div);

                // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤–Ω—É—Ç—Ä—å span
                const newRange = document.createRange();
                newRange.setStart(div.querySelector('span'), 0);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            } else {
                // –ï—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫
                const fragment = document.createDocumentFragment();
                lines.forEach(line => {
                    fragment.appendChild(createChecklistItem(line));
                });
                range.deleteContents();
                range.insertNode(fragment);
            }

            document.getElementById('notes-editor').focus();
        }

        function createChecklistItem(text) {
            const div = document.createElement('div');
            div.className = 'checklist-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';

            const span = document.createElement('span');
            // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª, —á—Ç–æ–±—ã –∫—É—Ä—Å–æ—Ä –º–æ–≥ –≤—Å—Ç–∞—Ç—å
            span.textContent = text || '\u00A0';

            div.appendChild(checkbox);
            div.appendChild(span);
            return div;
        }

        function ensureAudioContext() {
            // Play silence to allow background media session on iOS
            const silence = document.getElementById('silence-loop');
            const mainAudio = document.getElementById('audio');
            if (mainAudio.paused && silence.paused) {
                silence.play().catch(() => { });
            }
        }

    </script>
</body>

</html>
